---
- import_playbook: validations/validate_usm_agent_configs.yml
  tags:
    - validate_usm_agent_configs
    - validate
    - always

- name: USM Agent Status Finding
  hosts: usm_agent
  gather_facts: false
  tags: usm_agent
  environment: "{{ proxy_env }}"
  tasks:
    - import_role:
        name: variables

    - name: Populate service facts
      service_facts:

    - name: Determine Installation Pattern - Parallel or Serial
      set_fact:
        install_pattern: "{{ 'parallel' if service_state != 'running' or usm_agent_deployment_strategy == 'parallel' else 'serial' }}"
      vars:
        service_state: "{{ ansible_facts.services[usm_agent_service_name + '.service'].state | default('unknown') }}"

    - name: Group Hosts by Installation Pattern
      group_by:
        key: usm_agent_{{install_pattern}}
      changed_when: false

- name: USM Agent Parallel Provisioning
  hosts: usm_agent_parallel
  gather_facts: false
  tags: usm_agent
  environment: "{{ proxy_env }}"
  tasks:
    - import_role:
        name: usm_agent

- name: USM Agent Serial Provisioning
  hosts: usm_agent_serial
  serial: 1
  any_errors_fatal: true
  gather_facts: false
  tags: usm_agent
  environment: "{{ proxy_env }}"
  tasks:
    - import_role:
        name: usm_agent

    - name: Proceed Prompt
      pause:
        prompt: "Press Enter to Proceed to Next Node. Ctrl + C to Abort"
      when: usm_agent_pause_rolling_deployment|bool
