---
### Test USM Agent mTLS Authentication with CP Components

- name: Test USM Agent mTLS Configuration
  hosts: usm_agent
  gather_facts: false
  tasks:
    - import_role:
        name: variables

    - name: Test healthz endpoint with curl
      shell: |
        curl -f -s -o /dev/null -w "%{http_code}" \
        http://localhost:{{ usm_agent_admin_port | default(9901) }}/healthz
      register: curl_health_check
      retries: 15
      delay: 10
      until: curl_health_check.stdout == "200"

    - name: Display health check result
      debug:
        msg: "Health check returned HTTP status: {{ curl_health_check.stdout }}"

    - name: Verify USM Agent Configuration File Exists
      stat:
        path: "{{ usm_agent.config_file }}"
      register: config_file_check

    - name: Assert Configuration File Exists
      assert:
        that:
          - config_file_check.stat.exists
        fail_msg: "USM Agent configuration file does not exist"
        success_msg: "USM Agent configuration file exists"

    - name: Verify Basic Auth is Disabled in Properties
      shell: "grep -q 'confluent.usm-agent.listener.dataplane.basic.auth.enabled=false' {{ usm_agent.config_file }}"
      register: basic_auth_disabled_check

    - name: Verify SSL is Enabled in Properties
      shell: "grep -q 'confluent.usm-agent.listener.dataplane.ssl.enabled=true' {{ usm_agent.config_file }}"
      register: ssl_enabled_check

    - name: Verify SSL Mutual Auth is Enabled
      shell: "grep -q 'confluent.usm-agent.listener.dataplane.ssl.client.auth.enabled=true' {{ usm_agent.config_file }}"
      register: mtls_enabled_check

    - name: Verify mTLS Client Authentication Method
      shell: "grep -q 'confluent.usm-agent.listener.dataplane.ssl.client.authentication=require' {{ usm_agent.config_file }}"
      register: mtls_require_check

    - name: Assert mTLS Configuration
      assert:
        that:
          - basic_auth_disabled_check.rc == 0
          - ssl_enabled_check.rc == 0
          - mtls_enabled_check.rc == 0
          - mtls_require_check.rc == 0
        fail_msg: "USM Agent mTLS configuration is incorrect"
        success_msg: "USM Agent mTLS configuration is correct"

    - name: Verify Basic Auth Credential File Does NOT Exist (mTLS only)
      stat:
        path: "{{ usm_agent.cp_credential_file }}"
      register: cp_cred_file_check

    - name: Assert Basic Auth Credential File Does NOT Exist
      assert:
        that:
          - not cp_cred_file_check.stat.exists
        fail_msg: "USM Agent basic auth credential file should not exist in mTLS mode"
        success_msg: "USM Agent basic auth credential file correctly does not exist in mTLS mode"

    - name: Verify SSL Certificate Files Exist
      stat:
        path: "{{ item }}"
      register: ssl_file_checks
      loop:
        - "{{ usm_agent_cert_path }}"
        - "{{ usm_agent_key_path }}"
        - "{{ usm_agent_ca_cert_path }}"
      failed_when: false

    - name: Assert SSL Certificate Files Exist
      assert:
        that:
          - item.stat.exists
        fail_msg: "SSL certificate file {{ item.item }} does not exist"
        success_msg: "SSL certificate file {{ item.item }} exists"
      loop: "{{ ssl_file_checks.results }}"

- name: Test USM Agent Client Configuration in CP Components (mTLS)
  hosts: kafka_controller:kafka_broker:kafka_connect
  gather_facts: false
  tasks:
    - import_role:
        name: variables

    - name: Get component name for logging
      set_fact:
        component_name: "{{ 'kafka-controller' if inventory_hostname in groups['kafka_controller'] else ('kafka-broker' if inventory_hostname in groups['kafka_broker'] else 'kafka-connect') }}"

    - name: Get config file path based on component
      set_fact:
        component_config_file: >-
          {%- if inventory_hostname in groups['kafka_controller'] -%}
          {{ kafka_controller.config_file }}
          {%- elif inventory_hostname in groups['kafka_broker'] -%}
          {{ kafka_broker.config_file }}
          {%- elif inventory_hostname in groups['kafka_connect'] -%}
          {{ kafka_connect.config_file }}
          {%- endif -%}

    - name: Verify USM Agent Telemetry is Enabled
      shell: "grep -q 'confluent.telemetry.enabled=true' {{ component_config_file }}"
      register: telemetry_enabled_check

    - name: Verify USM Agent Base URL is Set with HTTPS
      shell: "grep -q 'confluent.telemetry.base.url={{ usm_agent_url }}' {{ component_config_file }}"
      register: base_url_check

    - name: Verify USM Agent Dummy Credentials (mTLS mode)
      shell: "grep -q 'confluent.telemetry.api.key=dummy' {{ component_config_file }}"
      register: dummy_key_check

    - name: Verify SSL Configuration for USM Agent Client
      shell: "grep -q 'confluent.telemetry.exporter._confluent.https.ssl.protocol=TLSv1.2' {{ component_config_file }}"
      register: ssl_protocol_check

    - name: Verify Truststore Configuration
      shell: "grep -q 'confluent.telemetry.exporter._confluent.https.ssl.truststore.location' {{ component_config_file }}"
      register: truststore_check

    - name: Verify Keystore Configuration (mTLS)
      shell: "grep -q 'confluent.telemetry.exporter._confluent.https.ssl.keystore.location' {{ component_config_file }}"
      register: keystore_check

    - name: Assert USM Agent Client Configuration (mTLS)
      assert:
        that:
          - telemetry_enabled_check.rc == 0
          - base_url_check.rc == 0
          - dummy_key_check.rc == 0
          - ssl_protocol_check.rc == 0
          - truststore_check.rc == 0
          - keystore_check.rc == 0
        fail_msg: "USM Agent client configuration (mTLS) not found in {{ component_name }} config"
        success_msg: "USM Agent client configuration (mTLS) verified for {{ component_name }}"

    - name: Show component config snippet (for debugging)
      shell: "grep -A10 -B5 'confluent.telemetry' {{ component_config_file }} || echo 'No telemetry config found'"
      register: config_snippet

    - name: Display config snippet
      debug:
        msg: "{{ component_name }} USM config: {{ config_snippet.stdout_lines }}"
