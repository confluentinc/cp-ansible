---
### Manual health check test for USM Agent using correct endpoint

- name: Test USM Agent Health Endpoint
  hosts: usm_agent
  gather_facts: false
  tasks:
    - import_role:
        name: variables

    - name: Test healthz endpoint with curl
      shell: |
        curl -f -s -o /dev/null -w "%{http_code}" \
        http://localhost:{{ usm_agent_admin_port | default(9901) }}/healthz
      register: curl_health_check
      retries: 15
      delay: 10
      until: curl_health_check.stdout == "200"

    - name: Display health check result
      debug:
        msg: "Health check returned HTTP status: {{ curl_health_check.stdout }}"

    - name: Test healthz endpoint with detailed response
      shell: |
        curl -s http://localhost:{{ usm_agent_admin_port | default(9901) }}/healthz
      register: health_response

    - name: Display health response
      debug:
        msg: "Health endpoint response: {{ health_response.stdout }}"
