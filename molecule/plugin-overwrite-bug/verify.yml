---
- name: Verify Plugin Overwrite Bug Fix
  hosts: kafka_connect
  gather_facts: false
  tasks:
    - name: Check if custom JAR exists inside plugin directory
      stat:
        path: /usr/share/java/connect_plugins/jcustenborder-kafka-connect-spooldir/ibm-mq-connector.jar
      register: custom_jar_check

    - name: Display custom JAR status
      debug:
        msg: "Custom JAR exists inside plugin directory: {{ custom_jar_check.stat.exists }}"

    - name: Check if root level JAR exists
      stat:
        path: /usr/share/java/connect_plugins/ibm-mq-connector.jar
      register: root_jar_check

    - name: Display root JAR status
      debug:
        msg: "Root level JAR exists: {{ root_jar_check.stat.exists }}"

    - name: List plugin directory contents
      shell: ls -la /usr/share/java/connect_plugins/jcustenborder-kafka-connect-spooldir/
      register: plugin_contents
      changed_when: false

    - name: Display plugin contents
      debug:
        msg: "Plugin directory contents: {{ plugin_contents.stdout_lines }}"

    - name: Fail if custom JAR is missing (bug not fixed)
      fail:
        msg: "BUG NOT FIXED: Custom JAR was overwritten during plugin installation!"
      when: not custom_jar_check.stat.exists

    - name: Success message if bug is fixed
      debug:
        msg: "SUCCESS: Plugin overwrite bug is fixed - custom JAR is preserved!"
      when: custom_jar_check.stat.exists

### Custom JAR preservation during plugin installation
### Plugin directory structure validation
### Root level JAR file existence check
### Plugin installation success verification
