---
### SR Automation Workflow Test Environment Preparation - LDAP/RBAC + mTLS
### Imports base preparation and adds LDAP + mTLS specific setup

- import_playbook: ../base_templates/sr_automation_prepare_base.yml

- name: LDAP + mTLS Specific Preparation  
  hosts: all
  gather_facts: false
  tasks:
    - name: Display LDAP + mTLS scenario information
      debug:
        msg: |
          LDAP + mTLS SR Automation Testing Setup:
          - LDAP server: {{ ldap_url | default('ldaps://ldap-server1:636') }}
          - LDAP base DN: {{ ldap_search_base | default('OU=rbac,DC=confluent,DC=local') }}
          - mTLS certificates: Will be generated for secure communication
          - RBAC authorization: Enabled with MDS integration
          - Test users: sr-admin, sr-user, sr-exporter, sr-importer, mds-user
      run_once: true

- name: Certificate Preparation for mTLS
  hosts: all
  gather_facts: false
  tasks:
    - name: Verify certificate generation for mTLS
      stat:
        path: "{{ ssl_file_dir_final }}/schema_registry.crt"
      register: cert_check
      when: ssl_mutual_auth_enabled | default(false)

    - name: Display mTLS certificate status
      debug:
        msg: |
          mTLS Certificate Configuration:
          - SSL enabled: {{ ssl_enabled | default(false) }}
          - Mutual auth enabled: {{ ssl_mutual_auth_enabled | default(false) }}
          - Certificates directory: {{ ssl_file_dir_final | default('not-configured') }}
          - Schema Registry cert: {{ 'EXISTS' if cert_check.stat.exists | default(false) else 'PENDING' }}

- name: LDAP + mTLS Configuration Verification
  hosts: schema_registry
  gather_facts: false
  tasks:
    - name: Verify LDAP + mTLS environment variables
      assert:
        that:
          - ssl_enabled | default(false) == true
          - ssl_mutual_auth_enabled | default(false) == true
          - ldap_enabled | default(false) == true
          - rbac_enabled | default(false) == true
          - schema_registry_authentication_type == 'ldap'
          - ldap_url is defined
          - ldap_search_base is defined
        fail_msg: "LDAP + mTLS scenario configuration validation failed"

    - name: Display LDAP + mTLS scenario readiness
      debug:
        msg: |
          âœ“ LDAP + mTLS SR Automation Test Environment Ready
          - LDAP server: {{ ldap_url }}
          - LDAP base DN: {{ ldap_search_base }}
          - mTLS certificates: {{ 'READY' if cert_check.stat.exists | default(false) else 'PENDING' }}
          - RBAC authorization enabled
          - Test users provisioned via confluent.test.ldap role
          - Ready for enterprise-grade secure automation testing
          
          LDAP Test Users Available:
          - sr-admin (Schema Registry admin)
          - sr-user (Schema Registry user)  
          - sr-exporter (Schema exporter service user)
          - sr-importer (Schema importer service user)
          - mds-user (MDS service user)