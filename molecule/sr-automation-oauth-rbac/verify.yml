---
### SR Automation Workflow Verification - OAuth + RBAC
### Imports base verification and adds OAuth + RBAC specific checks

- import_playbook: ../base_templates/sr_automation_verify_base.yml

- name: OAuth + RBAC Specific Verification
  hosts: schema_registry
  gather_facts: false
  tasks:
    - name: Check OAuth configuration properties
      import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/schema-registry/schema-registry.properties
        property: confluent.schema.registry.auth.mechanism
        expected_value: OAUTH
      tags: oauth

    - name: Check RBAC authorizer configuration
      import_role:
        name: confluent.test
        tasks_from: check_property.yml
      vars:
        file_path: /etc/schema-registry/schema-registry.properties  
        property: confluent.schema.registry.authorizer.class
        expected_value: io.confluent.kafka.schemaregistry.security.authorizer.rbac.RbacAuthorizer
      tags: rbac

    - name: Verify OAuth server accessibility
      uri:
        url: "{{ oauth_jwks_uri }}"
        method: GET
        validate_certs: false
        status_code: 200
      register: oauth_server_check
      tags: oauth

    - name: Test OAuth token endpoint
      uri:
        url: "{{ oauth_token_uri }}"
        method: POST
        validate_certs: false
        body_format: form-urlencoded
        body:
          grant_type: client_credentials
          client_id: "sr-automation-client"
          client_secret: "sr-automation-secret"
        status_code: 200
      register: oauth_token_test
      ignore_errors: true
      tags: oauth

    - name: Display OAuth + RBAC verification summary
      debug:
        msg: |
          âœ“ OAuth + RBAC SR Automation Verification Complete:
          - OAuth server: {{ 'ACCESSIBLE' if oauth_server_check is succeeded else 'FAILED' }}
          - Token endpoint: {{ 'WORKING' if oauth_token_test is succeeded else 'NEEDS_SETUP' }}
          - RBAC authorizer: {{ 'CONFIGURED' }}
          - Security level: OAuth authentication + RBAC authorization
          - Automation features: Ready for token-based authentication
      tags: oauth