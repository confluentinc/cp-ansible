---
- name: Configure IPv6 Preference
  hosts: all
  tasks:
    - name: Ensure /etc/gai.conf exists and prefers IPv6
      copy:
        dest: /etc/gai.conf
        content: |
          precedence ::1/128  50
          precedence ::/0  50
          precedence 2002::/16  30
          precedence ::ffff:0:0/96  0
      when: lookup('env', 'IPV6_ENABLE')|default('false')|lower == 'true'

- name: Remove the Zookeeper, Kafka Broker, Schema Registry and Kafka Rest Groups from Inventory
  hosts: kafka_broker
  gather_facts: false
  tasks:
    - name: "Change {{item}} Group Name in Inventory File for MDS"
      lineinfile:
        path: "{{inventory_dir}}/ansible_inventory.yml"
        regexp: "{{item}}:"
        line: "{{item}}_mds:"
      delegate_to: 127.0.0.1
      run_once: true
      loop:
        - zookeeper
        - kafka_controller
        - kafka_broker

    - name: "Change {{item}} Group Name in Inventory File for cluster2"
      lineinfile:
        path: "{{inventory_dir}}/ansible_inventory.yml"
        regexp: "{{item}}2:"
        line: "{{item}}:"
      delegate_to: 127.0.0.1
      run_once: true
      loop:
        - zookeeper
        - kafka_controller
        - kafka_broker
        - kafka_connect_replicator

    - name: Refresh Inventory
      meta: refresh_inventory

- name: Converge
  import_playbook: confluent.platform.all
