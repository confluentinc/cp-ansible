---
- name: Verify USM Agent Functionality
  hosts: usm_agent
  gather_facts: true
  vars:
    # USM Agent configuration
    usm_agent_host: "{{ inventory_hostname }}"
    usm_agent_controlplane_port: 9999
    usm_agent_log_file: "/var/log/confluent/usm-agent/usm-agent_access.log"

    # CCloud Mock Service configuration
    ccloud_mock_host: "ccloud-mock-service"
    ccloud_mock_port: 8081
    ccloud_mock_user: "ccloud-user"
    ccloud_mock_password: "ccloud-secret"

  tasks:
    # USM Agent Health Check
    - name: Check USM Agent service is running
      shell: "systemctl is-active confluent-usm-agent || systemctl status confluent-usm-agent"
      register: usm_service_status
      failed_when: false

    - name: Debug - USM Agent service status
      debug:
        msg: "USM Agent service status: {{ usm_service_status.stdout_lines }}"

    - name: Check USM Agent health
      uri:
        url: "http://{{ usm_agent_host }}:{{ usm_agent_controlplane_port }}/healthz"
        method: GET
        status_code: 200
        timeout: 10
      register: usm_healthz_check
      retries: 5
      delay: 10
      until: usm_healthz_check.status == 200

    - name: Check if any clients are registered with USM Agent
      uri:
        url: "http://{{ usm_agent_host }}:{{ usm_agent_controlplane_port }}/api/v1/clients"
        method: GET
        status_code: 200
        timeout: 10
      register: usm_clients
      failed_when: false

    - name: Debug - Registered clients
      debug:
        msg: "Registered clients: {{ usm_clients.json | default('Unable to fetch clients') }}"

    - name: Check if USM Agent can reach CCloud mock service
      shell: "curl -v http://{{ ccloud_mock_host }}:{{ ccloud_mock_port }}/healthz 2>&1"
      register: ccloud_connectivity
      failed_when: false

    - name: Debug - CCloud mock connectivity
      debug:
        msg: "CCloud mock connectivity: {{ ccloud_connectivity.stdout_lines }}"

    # Get baseline events count
    - name: Get baseline events count
      uri:
        url: "http://{{ ccloud_mock_host }}:{{ ccloud_mock_port }}/events_count"
        method: GET
        user: "{{ ccloud_mock_user }}"
        password: "{{ ccloud_mock_password }}"
        force_basic_auth: true
        status_code: 200
        timeout: 10
      register: baseline_events_count

    # Check USM Agent logs
    - name: Check USM Agent access logs
      stat:
        path: "{{ usm_agent_log_file }}"
      register: log_file_stat

    - name: Wait for USM Agent to send events (initial grace period)
      pause:
        seconds: 30
        prompt: "Waiting 30 seconds for USM Agent to collect and send events..."
      when: log_file_stat.stat.exists

    - name: Search for v1/events endpoint in logs (204) with retries
      shell: "grep -c 'POST.*v1/events.*204' {{ usm_agent_log_file }} 2>/dev/null || echo '0'"
      register: events_grep_result
      retries: 12
      delay: 10
      until: (events_grep_result.stdout | int) > 0
      when: log_file_stat.stat.exists
      failed_when: false

    - name: Search for v1/metrics endpoint in logs (200)
      shell: "grep -c 'POST.*v1/metrics.*200' {{ usm_agent_log_file }} 2>/dev/null || echo '0'"
      register: metrics_grep_result
      when: log_file_stat.stat.exists

    - name: Debug - Show events count
      debug:
        msg: "Events found: {{ events_grep_result.stdout | default('0') }}, Metrics found: {{ metrics_grep_result.stdout | default('0') }}"
      when: log_file_stat.stat.exists

    - name: Check USM Agent main log for errors
      shell: "tail -50 /var/log/confluent/usm-agent/usm-agent.log | grep -iE 'error|failed|exception' || echo 'No errors found'"
      register: usm_main_log_errors
      when: 
        - log_file_stat.stat.exists
        - (events_grep_result.stdout | default('0') | int) == 0
      failed_when: false

    - name: Debug - USM Agent main log errors
      debug:
        msg: "{{ usm_main_log_errors.stdout_lines }}"
      when:
        - log_file_stat.stat.exists
        - (events_grep_result.stdout | default('0') | int) == 0
        - usm_main_log_errors.stdout is defined

    - name: Debug - Show last 20 lines of USM Agent access log
      shell: "tail -20 {{ usm_agent_log_file }}"
      register: access_log_tail
      when: 
        - log_file_stat.stat.exists
        - (events_grep_result.stdout | default('0') | int) == 0
      failed_when: false

    - name: Debug - Display access log tail if no events found
      debug:
        msg: "{{ access_log_tail.stdout_lines }}"
      when:
        - log_file_stat.stat.exists
        - (events_grep_result.stdout | default('0') | int) == 0
        - access_log_tail.stdout is defined

    - name: Check if Kafka brokers are configured to use USM Agent
      shell: "grep -iE 'usm.agent|usage.telemetry' /etc/kafka/server.properties || echo 'No USM Agent config found'"
      register: broker_usm_config
      delegate_to: "{{ groups['kafka_broker'][0] }}"
      when:
        - log_file_stat.stat.exists
        - (events_grep_result.stdout | default('0') | int) == 0
        - "'kafka_broker' in groups"
        - groups['kafka_broker'] | length > 0
      failed_when: false

    - name: Debug - Kafka broker USM Agent configuration
      debug:
        msg: "{{ broker_usm_config.stdout_lines }}"
      when:
        - log_file_stat.stat.exists
        - (events_grep_result.stdout | default('0') | int) == 0
        - broker_usm_config.stdout is defined

    - name: Set events endpoint found fact
      set_fact:
        events_endpoint_found: "{{ (events_grep_result.stdout | default('0') | int) > 0 }}"
      when: log_file_stat.stat.exists

    - name: Set metrics endpoint found fact
      set_fact:
        metrics_endpoint_found: "{{ (metrics_grep_result.stdout | default('0') | int) > 0 }}"
      when: log_file_stat.stat.exists

    # Verification assertions
    - name: Assert USM Agent log file exists
      assert:
        that:
          - log_file_stat.stat.exists
        fail_msg: "USM Agent access log file does not exist at {{ usm_agent_log_file }}"

    - name: Assert v1/events endpoint is working
      assert:
        that:
          - events_endpoint_found | default(false)
        fail_msg: "USM Agent v1/events endpoint not found in logs or not returning 204 status"
      when: log_file_stat.stat.exists

    - name: Assert v1/metrics endpoint is working
      assert:
        that:
          - metrics_endpoint_found | default(false)
        fail_msg: "USM Agent v1/metrics endpoint not found in logs or not returning 200 status"
      when: log_file_stat.stat.exists
