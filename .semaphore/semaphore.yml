version: v1.0
name: Cp-ansible-certify Pipeline
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
execution_time_limit:
  minutes: 20
queue:
  processing: parallel
global_job_config:
  prologue:
    commands:
      - checkout
      - git branch
      - VERSION_LINE=$(cat ~/cp-ansible/galaxy.yml | grep version)
      - export VERSION=${VERSION_LINE:9}
      - echo $VERSION
      - export MINOR_VERSION=${VERSION:0:3}
      - echo $MINOR_VERSION
      - export ARTEFACT="confluent-platform-$VERSION.tar.gz"
      - echo $ARTEFACT
      - export ARTEFACT_FULL_PATH=~/cp-ansible/"${ARTEFACT}"
      - echo $ARTEFACT_FULL_PATH

blocks:
  - name: Build Collection Block
    dependencies: []
    task:
      jobs:
        - name: 'Build Collection Block'
          commands:
            - export ANSIBLE_VERSION=9
            - export ANSIBLE_CORE_VERSION=2.16
            - export PYTHON_VERSION=3.12
            - echo "py-version -> $PYTHON_VERSION; ansi-core-version -> $ANSIBLE_CORE_VERSION"
            - bash $HOME/cp-ansible/.semaphore/build_collection.sh
            - artifact push workflow $ARTEFACT_FULL_PATH

  - name: 'Ansible 9 Python 3.12 Sanity Checks'
    dependencies:
      - Build Collection Block
    task:
      jobs:
        - name: 'Galaxy Importer + Sanity Tests'
          commands:
            - export ANSIBLE_VERSION=9
            - export ANSIBLE_CORE_VERSION=2.16
            - export PYTHON_VERSION=3.12
            - echo "py-version -> $PYTHON_VERSION; ansi-core-version -> $ANSIBLE_CORE_VERSION"
            - cd $HOME/cp-ansible
            - artifact pull workflow $ARTEFACT
            - bash $HOME/cp-ansible/.semaphore/sanity_tests.sh

  - name: 'Ansible 9 Python 3.11 Sanity Checks'
    dependencies:
      - Build Collection Block
    task:
      jobs:
        - name: 'Galaxy Importer + Sanity Tests'
          commands:
            - export ANSIBLE_VERSION=9
            - export ANSIBLE_CORE_VERSION=2.16
            - export PYTHON_VERSION=3.11
            - echo "py-version -> $PYTHON_VERSION; ansi-core-version -> $ANSIBLE_CORE_VERSION"
            - cd $HOME/cp-ansible
            - artifact pull workflow $ARTEFACT
            - bash $HOME/cp-ansible/.semaphore/sanity_tests.sh

  - name: 'Ansible 9 Python 3.10 Sanity Checks'
    dependencies:
      - Build Collection Block
    task:
      jobs:
        - name: 'Galaxy Importer + Sanity Tests'
          commands:
            - export ANSIBLE_VERSION=9
            - export ANSIBLE_CORE_VERSION=2.16
            - export PYTHON_VERSION=3.10
            - echo "py-version -> $PYTHON_VERSION; ansi-core-version -> $ANSIBLE_CORE_VERSION"
            - cd $HOME/cp-ansible
            - artifact pull workflow $ARTEFACT
            - bash $HOME/cp-ansible/.semaphore/sanity_tests.sh
# add a block for molecule test as well