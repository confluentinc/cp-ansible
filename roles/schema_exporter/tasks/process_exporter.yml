---
- name: Set exporter configuration
  set_fact:
    schema_exporter_config:
      name: "{{ exporter.name }}"
      context_type: "{{ exporter.context_type | default('AUTO') }}"
      context: "{{ exporter.remote_context | default('') }}"
      subjects: "{{ exporter.subjects | default([]) }}"
      kek_rename_format: "{{ exporter.kek_rename_format | default('') }}"
      subject_rename_format: "{{ exporter.subject_rename_format | default('') }}"
      config: "{{ schema_exporter_final_config }}"
  vars:
    base_config: "{{ exporter.config | default({}) }}"
    override_config: "{{ exporter.config_overrides | default({}) }}"
    # Transform inventory config to API format
    api_config:
      schema.registry.url: "{{ base_config.remote_schema_registry_endpoint }}"
      basic.auth.credentials.source: "{{ 'USER_INFO' if base_config.remote_authentication_type == 'basic' else omit }}"
      basic.auth.user.info: "{{ base_config.basic_username + ':' + base_config.basic_password if base_config.remote_authentication_type == 'basic' else omit }}"
    schema_exporter_final_config: "{{ api_config | combine(override_config) }}"

- name: Check if Schema Exporter exists
  uri:
    url: "{{ schema_registry_http_protocol }}://{{ inventory_hostname }}:{{ schema_registry_listener_port }}/exporters/{{ schema_exporter_config.name }}"
    method: GET
    status_code: [200, 404]
    validate_certs: false
    user: "{{ schema_registry_health_check_user if schema_registry_authentication_type == 'basic' else omit }}"
    password: "{{ schema_registry_health_check_password if schema_registry_authentication_type == 'basic' else omit }}"
  register: exporter_check
  ignore_errors: true

- name: Create Schema Exporter
  uri:
    url: "{{ schema_registry_http_protocol }}://{{ inventory_hostname }}:{{ schema_registry_listener_port }}/exporters"
    method: POST
    body_format: json
    body: "{{ exporter_request_body }}"
    status_code: [200]
    validate_certs: false
    user: "{{ schema_registry_health_check_user if schema_registry_authentication_type == 'basic' else omit }}"
    password: "{{ schema_registry_health_check_password if schema_registry_authentication_type == 'basic' else omit }}"
  vars:
    base_request_body:
      name: "{{ schema_exporter_config.name }}"
      subjects: "{{ schema_exporter_config.subjects }}"
      config: "{{ schema_exporter_config.config }}"
    context_type_field: "{{ {'contextType': schema_exporter_config.context_type} if schema_exporter_config.context_type != 'AUTO' else {} }}"
    context_field: "{{ {'context': schema_exporter_config.context} if schema_exporter_config.context_type not in ['NONE', 'AUTO'] else {} }}"
    kek_rename_field: "{{ {'kekRenameFormat': schema_exporter_config.kek_rename_format} if schema_exporter_config.kek_rename_format | default('') != '' else {} }}"
    subject_rename_field: "{{ {'subjectRenameFormat': schema_exporter_config.subject_rename_format} if schema_exporter_config.subject_rename_format | default('') != '' else {} }}"
    exporter_request_body: "{{ base_request_body | combine(context_type_field) | combine(context_field) | combine(kek_rename_field) | combine(subject_rename_field) }}"
  register: exporter_creation
  when: exporter_check.status == 404

- name: Pause Schema Exporter
  uri:
    url: "{{ schema_registry_http_protocol }}://{{ inventory_hostname }}:{{ schema_registry_listener_port }}/exporters/{{ schema_exporter_config.name }}/pause"
    method: PUT
    status_code: [200, 202]
    validate_certs: false
    user: "{{ schema_registry_health_check_user if schema_registry_authentication_type == 'basic' else omit }}"
    password: "{{ schema_registry_health_check_password if schema_registry_authentication_type == 'basic' else omit }}"
  register: exporter_pause
  until: exporter_pause.status in [200]
  retries: 10
  delay: 2
  when: exporter_check.status == 200

- name: Update Schema Exporter
  uri:
    url: "{{ schema_registry_http_protocol }}://{{ inventory_hostname }}:{{ schema_registry_listener_port }}/exporters/{{ schema_exporter_config.name }}"
    method: PUT
    body_format: json
    body: "{{ exporter_update_body }}"
    status_code: 200
    validate_certs: false
    user: "{{ schema_registry_health_check_user if schema_registry_authentication_type == 'basic' else omit }}"
    password: "{{ schema_registry_health_check_password if schema_registry_authentication_type == 'basic' else omit }}"
  vars:
    # Include all updatable fields
    base_update_body:
      subjects: "{{ schema_exporter_config.subjects }}"
      config: "{{ schema_exporter_config.config }}"
    context_type_field: "{{ {'contextType': schema_exporter_config.context_type} if schema_exporter_config.context_type != 'AUTO' else {} }}"
    context_field: "{{ {'context': schema_exporter_config.context} if schema_exporter_config.context_type not in ['NONE', 'AUTO'] else {} }}"
    kek_rename_field: "{{ {'kekRenameFormat': schema_exporter_config.kek_rename_format} if schema_exporter_config.kek_rename_format | default('') != '' else {} }}"
    subject_rename_field: "{{ {'subjectRenameFormat': schema_exporter_config.subject_rename_format} if schema_exporter_config.subject_rename_format | default('') != '' else {} }}"
    exporter_update_body: "{{ base_update_body | combine(context_type_field) | combine(context_field) | combine(kek_rename_field) | combine(subject_rename_field) }}"
  register: exporter_update
  when: exporter_check.status == 200

- name: Resume Schema Exporter
  uri:
    url: "{{ schema_registry_http_protocol }}://{{ inventory_hostname }}:{{ schema_registry_listener_port }}/exporters/{{ schema_exporter_config.name }}/resume"
    method: PUT
    status_code: [200, 202]
    validate_certs: false
    user: "{{ schema_registry_health_check_user if schema_registry_authentication_type == 'basic' else omit }}"
    password: "{{ schema_registry_health_check_password if schema_registry_authentication_type == 'basic' else omit }}"
  register: exporter_resume
  when: exporter_check.status == 200 and exporter_update is defined

- name: Register Schema Exporter Status
  uri:
    url: "{{ schema_registry_http_protocol }}://{{ inventory_hostname }}:{{ schema_registry_listener_port }}/exporters/{{ schema_exporter_config.name }}/status"
    method: GET
    status_code: 200
    validate_certs: false
    user: "{{ schema_registry_health_check_user if schema_registry_authentication_type == 'basic' else omit }}"
    password: "{{ schema_registry_health_check_password if schema_registry_authentication_type == 'basic' else omit }}"
  register: exporter_status

- name: Set Schema Exporter State
  set_fact:
    schema_exporter_state: "{{ exporter_status.json.state}}"
    schema_exporter_configured: true
