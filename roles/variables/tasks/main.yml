---
# This task ensures consistency between SSL mutual authentication and client authentication variables
# across different components (Kafka, Schema Registry, Kafka Connect, etc.)
#
# Rules:
# 1. If ssl_client_authentication is 'required' or 'requested', then ssl_mutual_auth_enabled must be true
# 2. If ssl_mutual_auth_enabled is true, then ssl_client_authentication must be 'required'
#
# To disable mutual TLS (mTLS), both variables must be set:
# - <component>_ssl_mutual_auth_enabled = false
# - <component>_ssl_client_authentication = 'none'
#
# Valid values for client authentication:
# - 'none': No client authentication
# - 'required': Client authentication is required
# - 'requested': Client authentication is requested but not required

- name: Define component SSL variable pairs
  set_fact:
    mtls_client_auth_pairs:
      - mutual_auth_var: ssl_mutual_auth_enabled
        client_auth_var: ssl_client_authentication
      - mutual_auth_var: schema_registry_ssl_mutual_auth_enabled
        client_auth_var: schema_registry_ssl_client_authentication
      - mutual_auth_var: kafka_connect_ssl_mutual_auth_enabled
        client_auth_var: kafka_connect_ssl_client_authentication
      - mutual_auth_var: kafka_rest_ssl_mutual_auth_enabled
        client_auth_var: kafka_rest_ssl_client_authentication
      - mutual_auth_var: kafka_connect_replicator_ssl_mutual_auth_enabled
        client_auth_var: kafka_connect_replicator_ssl_client_authentication

- name: Define ssl_mutual_auth_enabled variables
  set_fact:
    "{{ item.mutual_auth_var }}": true
  loop: "{{ mtls_client_auth_pairs }}"
  when:
    - lookup('vars', item.client_auth_var) in ['required','requested']
    - not lookup('vars', item.mutual_auth_var)|bool
  register: mutual_auth_result

- name: Define ssl_client_authentication variables
  set_fact:
    "{{ item.client_auth_var }}": required
  loop: "{{ mtls_client_auth_pairs }}"
  when:
    - lookup('vars', item.mutual_auth_var)|bool
    - lookup('vars', item.client_auth_var) == 'none'

- name: Update SSL mutual authentication in Kafka broker listeners
  set_fact:
    kafka_broker_listeners: "{{ kafka_broker_listeners | combine({listener_name: kafka_broker_listeners[listener_name] | combine({'ssl_mutual_auth_enabled': true})}) }}"
  loop: "{{ kafka_broker_listeners.keys() | list }}"
  loop_control:
    loop_var: listener_name
  when:
    - kafka_broker_listeners is defined
    - kafka_broker_listeners[listener_name].ssl_client_authentication in ['required', 'requested']
    - not kafka_broker_listeners[listener_name].ssl_mutual_auth_enabled | bool

- name: Update SSL client authentication in Kafka broker listeners
  set_fact:
    kafka_broker_listeners: "{{ kafka_broker_listeners | combine({listener_name: kafka_broker_listeners[listener_name] | combine({'ssl_client_authentication': 'required'})}) }}"
  loop: "{{ kafka_broker_listeners.keys() | list }}"
  loop_control:
    loop_var: listener_name
  when:
    - kafka_broker_listeners is defined
    - kafka_broker_listeners[listener_name].ssl_mutual_auth_enabled | bool
    - kafka_broker_listeners[listener_name].ssl_client_authentication == 'none'
