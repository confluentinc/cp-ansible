---
- name: Wait for USM Agent service to be ready (Liveness Probe)
  uri:
    url: "http://{{ hostvars[inventory_hostname]|confluent.platform.resolve_hostname }}:{{ usm_agent_controlplane_port }}/healthz"
    status_code: 200
    validate_certs: false
    timeout: 2
  register: liveness_result
  until: liveness_result.status == 200
  retries: "{{ usm_agent_health_check_retries }}"
  delay: "{{ usm_agent_health_check_delay }}"
  when:
    - not ansible_check_mode
    - usm_agent_health_check_enabled|bool

- name: Wait for USM Agent service to be ready (Readiness Probe)
  uri:
    url: "http://{{ hostvars[inventory_hostname]|confluent.platform.resolve_hostname }}:{{ usm_agent_controlplane_port }}/readyz"
    status_code: 200
    validate_certs: false
    timeout: 2
  register: readiness_result
  until: readiness_result.status == 200
  retries: "{{ usm_agent_health_check_retries }}"
  delay: "{{ usm_agent_health_check_delay }}"
  when:
    - not ansible_check_mode
    - usm_agent_health_check_enabled|bool

- name: Verify USM Agent's Confluent Cloud Configurations (Credentials, Endpoint, Environment ID) are valid
  uri:
    url: "http://{{ hostvars[inventory_hostname]|confluent.platform.resolve_hostname }}:{{ usm_agent_controlplane_port }}/validz"
    status_code: 200
    validate_certs: false
    timeout: 2
  register: valid_result
  until: valid_result.status == 200
  retries: "{{ usm_agent_health_check_retries }}"
  delay: "{{ usm_agent_health_check_delay }}"
  when:
    - not ansible_check_mode
    - usm_agent_health_check_enabled|bool
    - usm_agent_validz_check_enabled|bool
