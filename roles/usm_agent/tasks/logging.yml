---
- name: Create USM Agent Logs Directory
  file:
    path: "{{usm_agent.log_dir}}"
    state: directory
    group: "{{usm_agent_default_group}}"
    owner: "{{usm_agent_default_user}}"
    mode: '770'

- name: Create USM Agent Log File
  file:
    path: "{{usm_agent.log_dir}}/usm-agent.log"
    state: touch
    group: "{{usm_agent_default_group}}"
    owner: "{{usm_agent_default_user}}"
    mode: '640'

- name: Configure USM Agent Systemd Logging
  template:
    src: usm-agent-logging.conf.j2
    dest: /etc/systemd/system/{{usm_agent_service_name}}.service.d/logging.conf
    mode: '644'
    owner: root
    group: root
  notify: restart usm agent

- name: Configure USM Agent Logrotate
  template:
    src: usm-agent.logrotate.j2
    dest: /etc/logrotate.d/usm-agent
    mode: '644'
    owner: root
    group: root

- name: Create USM Agent Logrotate Wrapper Script
  template:
    src: logrotate-usm-agent.sh.j2
    dest: /usr/local/bin/logrotate-usm-agent.sh
    mode: '755'
    owner: root
    group: root

- name: Install Cron Package for USM Agent Log Rotation
  package:
    name: cronie
    state: present
  register: install_cron_result
  until: install_cron_result is success or ansible_check_mode
  retries: 3
  delay: 30
  ignore_errors: "{{ ansible_check_mode }}"

- name: Enable and Start Cron Service
  systemd:
    name: crond
    enabled: true
    state: started
  when: not ansible_check_mode

- name: Add USM Agent Logrotate Cron Job
  cron:
    name: "USM Agent Log Rotation"
    minute: "*/10"
    job: "/usr/local/bin/logrotate-usm-agent.sh >> /tmp/usm-agent-rotate.log 2>&1"
    user: root
