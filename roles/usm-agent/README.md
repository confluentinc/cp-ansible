# USM Agent Role

This role manages the installation and configuration of Confluent USM Agent.

## Authentication Support

The USM Agent role supports multiple authentication types for the data plane interface, following the same pattern as other Confluent Platform components. Authentication type is automatically derived from global SSL settings:

1. **Basic Authentication** - Username/password authentication (when `ssl_mutual_auth_enabled: false`)
2. **Basic Authentication + TLS** - Username/password authentication with TLS encryption (when `ssl_enabled: true` and `ssl_mutual_auth_enabled: false`)
3. **mTLS Authentication** - Mutual TLS authentication using client certificates (when `ssl_enabled: true` and `ssl_mutual_auth_enabled: true`)

Authentication behavior follows established cp-ansible patterns where `usm_agent_authentication_type` is automatically set to `mtls` when mutual authentication is enabled, otherwise `none`.

### Configuration

#### Basic Authentication (No SSL)

```yaml
# Default behavior - no SSL settings needed
# ssl_enabled: false (default)
# ssl_mutual_auth_enabled: false (default)

# Define basic auth users - supports multiple CP clusters
usm_agent_basic_users:
  admin:
    principal: admin
    password: admin-secret
    roles: admin
  cluster1_user:
    principal: kafka-cluster1
    password: cluster1-secret
    roles: user
  cluster2_user:
    principal: kafka-cluster2
    password: cluster2-secret
    roles: user
```

#### Basic Authentication + TLS

```yaml
# Enable SSL but not mutual authentication
ssl_enabled: true
ssl_mutual_auth_enabled: false
self_signed: true  # or provide custom certificates

# Define basic auth users (same as basic auth)
usm_agent_basic_users:
  admin:
    principal: admin
    password: admin-secret
    roles: admin
  secure_cluster:
    principal: kafka-secure
    password: secure-secret
    roles: user
```

#### mTLS Authentication

```yaml
# Enable SSL with mutual authentication
ssl_enabled: true
ssl_mutual_auth_enabled: true
self_signed: true  # or provide custom certificates

# No basic auth users needed for mTLS - authentication via certificates
# usm_agent_authentication_type will automatically be set to 'mtls'
```

#### Custom Certificates

```yaml
# Use custom certificates instead of self-signed
ssl_enabled: true
ssl_custom_certs: true
ssl_ca_cert_filepath: "/path/to/ca-cert.crt"
ssl_signed_cert_filepath: "/path/to/usm-agent-cert.crt"
ssl_key_filepath: "/path/to/usm-agent-key.key"
# ssl_key_password: "password"  # if key is password protected
```

#### Properties Structure

The authentication configuration follows the same modular pattern as other CP components:

```yaml
usm_agent_properties:
  defaults:
    enabled: true
    properties:
      # Core USM Agent properties - use global SSL variables
      confluent.usm-agent.listener.dataplane.basic.auth.enabled: "{{ not usm_agent_ssl_mutual_auth_enabled }}"
      confluent.usm-agent.listener.dataplane.ssl.enabled: "{{ usm_agent_ssl_enabled }}"
      # ... other properties ...

  basic:
    enabled: "{{ not usm_agent_ssl_mutual_auth_enabled }}"
    properties:
      authentication.method: BASIC
      authentication.realm: USMAgent
      authentication.roles: "{{ usm_agent_basic_users | confluent.platform.get_roles | unique | join(',') }}"

  ssl:
    enabled: "{{ usm_agent_ssl_enabled }}"
    properties:
      confluent.usm-agent.listener.dataplane.ssl.keystore.location: "{{ usm_agent_keystore_path }}"
      confluent.usm-agent.listener.dataplane.ssl.truststore.location: "{{ usm_agent_truststore_path }}"
      # ... SSL properties ...

  mtls:
    enabled: "{{ usm_agent_ssl_mutual_auth_enabled }}"
    properties:
      confluent.usm-agent.listener.dataplane.ssl.client.authentication: "{{ usm_agent_ssl_client_authentication }}"
```

#### Generated CP Credential File Format

The generated `cp_credential.yaml` follows Envoy's basic auth filter format:

```yaml
"@type": "type.googleapis.com/envoy.config.core.v3.TypedExtensionConfig"
name: envoy.filters.http.basic_auth
typed_config:
  "@type": "type.googleapis.com/envoy.extensions.filters.http.basic_auth.v3.BasicAuth"
  users:
    inline_string: |-
      admin:{SHA}d033e22ae348aeb5660fc2140aec35850c4da997
      kafka-cluster1:{SHA}8cb2237d0679ca88db6464eac60da96345513964
      kafka-cluster2:{SHA}2fdb2b3bc8a7d3b4e0f8b44b3eaeb93e7b3b8c2f
```

Note: The SHA1 hashes are automatically generated by Ansible from the plaintext passwords.

### Files Created

When basic authentication is enabled, the role creates:

1. **CP Credential File**: `{{ usm_agent.cp_credential_file }}`
   - Contains SHA1-hashed credentials in Envoy basic auth format
   - Used by the data plane for authentication from CP components
   - Supports multiple users from different CP clusters
   - Format: `username:{SHA}sha1_hash_of_password`
   - File permissions: `-rw-r-----` (640)

2. **CCloud Credential File**: `{{ usm_agent.ccloud_credential_file }}`
   - Contains Confluent Cloud credentials
   - Required for USM Agent to communicate with CCloud

## TLS Configuration for CCloud Communication

The USM Agent communicates with Confluent Cloud over TLS (port 443). This role automatically:

1. **Installs CA Certificates**: The `ca-certificates` package is automatically installed
2. **Updates Certificate Store**: Certificate stores are refreshed after installation
3. **Configures Certificate Path**: OS-specific paths are automatically configured:
   - **RedHat/CentOS**: `/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem`
   - **Debian/Ubuntu**: `/etc/ssl/certs/ca-certificates.crt`

### Configuration

The certificate location is automatically set based on the operating system but can be overridden:

```yaml
# Override default certificate location (optional)
usm_agent_ccloud_ssl_trusted_ca_location: "/path/to/your/ca-bundle.pem"
```

The property is mapped to the USM Agent configuration as:
```properties
confluent.usm-agent.ccloud.ssl.trusted.ca.location={{ usm_agent_ccloud_ssl_trusted_ca_location }}
```

### Example Inventories

#### Basic Authentication Inventory (No SSL)
```yaml
all:
  vars:
    # Default SSL settings (no SSL)
    # ssl_enabled: false (default)
    # ssl_mutual_auth_enabled: false (default)

    # Define users for multiple CP clusters
    usm_agent_basic_users:
      admin:
        principal: admin
        password: admin-secret
        roles: admin
      prod_cluster:
        principal: kafka-prod
        password: prod-cluster-secret
        roles: user
      staging_cluster:
        principal: kafka-staging
        password: staging-cluster-secret
        roles: user

    # CCloud configuration
    usm_agent_ccloud_credential:
      username: "your-ccloud-key"
      password: "your-ccloud-secret"
    ccloud_endpoint: "https://your-ccloud-endpoint"
    ccloud_environment_id: "your-env-id"

usm_agent:
  hosts:
    usm-agent-01:
    usm-agent-02:
```

#### Basic Authentication + TLS Inventory
```yaml
all:
  vars:
    # Enable SSL but not mutual authentication
    ssl_enabled: true
    ssl_mutual_auth_enabled: false
    self_signed: true

    # Define users for multiple CP clusters
    usm_agent_basic_users:
      admin:
        principal: admin
        password: admin-secret
        roles: admin
      secure_cluster:
        principal: kafka-secure
        password: secure-cluster-secret
        roles: user

    # CCloud configuration
    usm_agent_ccloud_credential:
      username: "your-ccloud-key"
      password: "your-ccloud-secret"
    ccloud_endpoint: "https://your-ccloud-endpoint"
    ccloud_environment_id: "your-env-id"

usm_agent:
  hosts:
    usm-agent-01:
    usm-agent-02:
```

#### mTLS Authentication Inventory
```yaml
all:
  vars:
    # Enable SSL with mutual authentication
    ssl_enabled: true
    ssl_mutual_auth_enabled: true
    self_signed: true

    # No basic auth users needed for mTLS - authentication via certificates
    # usm_agent_authentication_type will automatically be set to 'mtls'

    # CCloud configuration
    usm_agent_ccloud_credential:
      username: "your-ccloud-key"
      password: "your-ccloud-secret"
    ccloud_endpoint: "https://your-ccloud-endpoint"
    ccloud_environment_id: "your-env-id"

usm_agent:
  hosts:
    usm-agent-01:
    usm-agent-02:
```

#### Custom Certificates Inventory
```yaml
all:
  vars:
    # Use custom certificates
    ssl_enabled: true
    ssl_mutual_auth_enabled: true
    ssl_custom_certs: true
    ssl_ca_cert_filepath: "/local/path/to/ca-cert.crt"
    ssl_signed_cert_filepath: "/local/path/to/{{inventory_hostname}}-cert.crt"
    ssl_key_filepath: "/local/path/to/{{inventory_hostname}}-key.key"
    # ssl_key_password: "keypass"  # if needed

    # CCloud configuration
    usm_agent_ccloud_credential:
      username: "your-ccloud-key"
      password: "your-ccloud-secret"
    ccloud_endpoint: "https://your-ccloud-endpoint"
    ccloud_environment_id: "your-env-id"

usm_agent:
  hosts:
    usm-agent-01:
    usm-agent-02:
```

### Testing

The USM Agent authentication functionality can be tested using multiple Molecule scenarios:

#### Basic Authentication (No SSL)
```bash
molecule test -s usm-agent-basic-rhel
```

#### Basic Authentication + TLS (SSL enabled, no mutual auth)
```bash
molecule test -s usm-agent-basic-tls-rhel
```

#### mTLS Authentication (SSL + mutual auth enabled)
```bash
molecule test -s usm-agent-mtls-rhel
```

Each test scenario will:
1. Deploy USM Agent with the respective SSL configuration
2. Verify appropriate credential files are created (for non-mTLS scenarios)
3. Verify SSL certificates are generated (when SSL is enabled)
4. Verify properties file contains correct authentication settings
5. Test health endpoint functionality
6. Verify CA certificates are installed for CCloud communication
7. Validate authentication type is correctly derived from SSL settings
