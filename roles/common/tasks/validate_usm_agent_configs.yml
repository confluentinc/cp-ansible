---
- name: Debug - Show host and group context for USM Agent validation
  debug:
    msg:
      - "=== USM Agent Validation Debug Info ==="
      - "Current host: {{ inventory_hostname }}"
      - "Host groups: {{ group_names }}"
      - "Is in usm_agent group: {{ 'usm_agent' in group_names }}"
      - "usm_agent group exists: {{ 'usm_agent' in groups }}"
      - "usm_agent group members: {{ groups.get('usm_agent', []) }}"
      - "usm_agent group size: {{ groups.get('usm_agent', []) | length }}"
  tags:
    - validate_usm_agent_configs

- name: Debug - Show USM Agent CCloud Credential values
  debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "usm_agent_ccloud_credential.username defined: {{ usm_agent_ccloud_credential.username is defined }}"
      - "usm_agent_ccloud_credential.username value: {{ usm_agent_ccloud_credential.username | default('UNDEFINED') }}"
      - "usm_agent_ccloud_credential.password defined: {{ usm_agent_ccloud_credential.password is defined }}"
      - "usm_agent_ccloud_credential.password length: {{ (usm_agent_ccloud_credential.password | default('')) | length }}"
  when:
    - "'usm_agent' in group_names"
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent CCloud Credentials are provided
  assert:
    that:
      - usm_agent_ccloud_credential.username is defined
      - usm_agent_ccloud_credential.username != ""
      - usm_agent_ccloud_credential.password is defined
      - usm_agent_ccloud_credential.password != ""
    fail_msg: "CCloud credentials (username and password) are required for USM Agent to function. Please provide ccloud_credential.username and ccloud_credential.password in your inventory."
    success_msg: "CCloud credentials validation passed"
  when:
    - "'usm_agent' in group_names"
  tags:
    - validate_usm_agent_configs

- name: Debug - Show USM Agent CCloud Configuration values
  debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "usm_agent_ccloud_host defined: {{ usm_agent_ccloud_host is defined }}"
      - "usm_agent_ccloud_host value: {{ usm_agent_ccloud_host | default('UNDEFINED') }}"
      - "usm_agent_ccloud_environment_id defined: {{ usm_agent_ccloud_environment_id is defined }}"
      - "usm_agent_ccloud_environment_id value: {{ usm_agent_ccloud_environment_id | default('UNDEFINED') }}"
  when:
    - "'usm_agent' in group_names"
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent CCloud Configuration is provided
  assert:
    that:
      - usm_agent_ccloud_host is defined
      - usm_agent_ccloud_host != ""
      - usm_agent_ccloud_environment_id is defined
      - usm_agent_ccloud_environment_id != ""
    fail_msg: "CCloud configuration (host and environment_id) are required for USM Agent to function. Please provide ccloud_host and ccloud_environment_id in your inventory."
    success_msg: "CCloud configuration validation passed"
  when:
    - "'usm_agent' in group_names"
  tags:
    - validate_usm_agent_configs

- name: Create USM Agent configuration baseline directory on control node
  file:
    path: "{{ playbook_dir }}/.usm_agent_baseline"
    state: directory
    mode: '755'
  delegate_to: localhost
  run_once: true
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
  tags:
    - validate_usm_agent_configs

- name: Record USM Agent Configuration Baseline (First Component Wins)
  copy:
    content: |
      {
        "basic_auth_enabled": {{ usm_agent_basic_auth_enabled | bool | to_json }},
        "ssl_enabled": {{ usm_agent_ssl_enabled | bool | to_json }},
        "ssl_mutual_auth_enabled": {{ usm_agent_ssl_mutual_auth_enabled | bool | to_json }},
        "recorded_by": "{{ inventory_hostname }}",
        "recorded_at": "{{ ansible_date_time.iso8601 }}"
      }
    dest: "{{ playbook_dir }}/.usm_agent_baseline/config.json"
    mode: '644'
    force: false
  delegate_to: localhost
  run_once: true
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
  tags:
    - validate_usm_agent_configs

- name: Read USM Agent Configuration Baseline
  slurp:
    src: "{{ playbook_dir }}/.usm_agent_baseline/config.json"
  register: usm_agent_baseline_raw
  delegate_to: localhost
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
  tags:
    - validate_usm_agent_configs

- name: Parse USM Agent Configuration Baseline
  set_fact:
    usm_agent_baseline: "{{ usm_agent_baseline_raw.content | b64decode | from_json }}"
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline_raw is defined
    - usm_agent_baseline_raw.content is defined
  tags:
    - validate_usm_agent_configs

- name: Debug - Show USM Agent Basic Auth Configuration values for comparison
  debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "Current host usm_agent_basic_auth_enabled: {{ usm_agent_basic_auth_enabled | bool }}"
      - "Baseline basic_auth_enabled: {{ usm_agent_baseline.basic_auth_enabled | default('BASELINE_NOT_LOADED') | bool }}"
      - "Baseline recorded by: {{ usm_agent_baseline.recorded_by | default('UNKNOWN') }}"
      - "Baseline recorded at: {{ usm_agent_baseline.recorded_at | default('UNKNOWN') }}"
      - "Values match: {{ (usm_agent_basic_auth_enabled | bool) == (usm_agent_baseline.basic_auth_enabled | default(false) | bool) }}"
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent Basic Auth Configuration Consistency
  assert:
    that:
      - (usm_agent_basic_auth_enabled | bool) == (usm_agent_baseline.basic_auth_enabled | bool)
    fail_msg: |
      USM Agent basic auth configuration inconsistency detected:
      - Baseline value (set by {{ usm_agent_baseline.recorded_by }}): {{ usm_agent_baseline.basic_auth_enabled }}
      - Current host ({{ inventory_hostname }}) value: {{ usm_agent_basic_auth_enabled | bool }}

      All components must have consistent usm_agent_basic_auth_enabled values.

      Baseline was recorded at: {{ usm_agent_baseline.recorded_at }}
      Either update {{ inventory_hostname }} to match the baseline, or redeploy all components with consistent configuration.
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Debug - Show USM Agent SSL Configuration values for comparison
  debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "Current host usm_agent_ssl_enabled: {{ usm_agent_ssl_enabled | bool }}"
      - "Baseline ssl_enabled: {{ usm_agent_baseline.ssl_enabled | default('BASELINE_NOT_LOADED') | bool }}"
      - "Baseline recorded by: {{ usm_agent_baseline.recorded_by | default('UNKNOWN') }}"
      - "Baseline recorded at: {{ usm_agent_baseline.recorded_at | default('UNKNOWN') }}"
      - "Values match: {{ (usm_agent_ssl_enabled | bool) == (usm_agent_baseline.ssl_enabled | default(false) | bool) }}"
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent SSL Configuration Consistency
  assert:
    that:
      - (usm_agent_ssl_enabled | bool) == (usm_agent_baseline.ssl_enabled | bool)
    fail_msg: |
      USM Agent SSL configuration inconsistency detected:
      - Baseline value (set by {{ usm_agent_baseline.recorded_by }}): {{ usm_agent_baseline.ssl_enabled }}
      - Current host ({{ inventory_hostname }}) value: {{ usm_agent_ssl_enabled | bool }}

      All components must have consistent usm_agent_ssl_enabled values.

      Baseline was recorded at: {{ usm_agent_baseline.recorded_at }}
      Either update {{ inventory_hostname }} to match the baseline, or redeploy all components with consistent configuration.
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Debug - Show USM Agent mTLS Configuration values for comparison
  debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "Current host usm_agent_ssl_mutual_auth_enabled: {{ usm_agent_ssl_mutual_auth_enabled | bool }}"
      - "Baseline ssl_mutual_auth_enabled: {{ usm_agent_baseline.ssl_mutual_auth_enabled | default('BASELINE_NOT_LOADED') | bool }}"
      - "Baseline recorded by: {{ usm_agent_baseline.recorded_by | default('UNKNOWN') }}"
      - "Baseline recorded at: {{ usm_agent_baseline.recorded_at | default('UNKNOWN') }}"
      - "Values match: {{ (usm_agent_ssl_mutual_auth_enabled | bool) == (usm_agent_baseline.ssl_mutual_auth_enabled | default(false) | bool) }}"
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent mTLS Configuration Consistency
  assert:
    that:
      - (usm_agent_ssl_mutual_auth_enabled | bool) == (usm_agent_baseline.ssl_mutual_auth_enabled | bool)
    fail_msg: |
      USM Agent mTLS configuration inconsistency detected:
      - Baseline value (set by {{ usm_agent_baseline.recorded_by }}): {{ usm_agent_baseline.ssl_mutual_auth_enabled }}
      - Current host ({{ inventory_hostname }}) value: {{ usm_agent_ssl_mutual_auth_enabled | bool }}

      All components must have consistent usm_agent_ssl_mutual_auth_enabled values.

      Baseline was recorded at: {{ usm_agent_baseline.recorded_at }}
      Either update {{ inventory_hostname }} to match the baseline, or redeploy all components with consistent configuration.
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs
