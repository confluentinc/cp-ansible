---
- name: Validate USM Agent CCloud Credentials are provided
  assert:
    that:
      - usm_agent_ccloud_credential.username is defined
      - usm_agent_ccloud_credential.username != ""
      - usm_agent_ccloud_credential.password is defined
      - usm_agent_ccloud_credential.password != ""
    fail_msg: "CCloud credentials (username and password) are required for USM Agent to function. Please provide ccloud_credential.username and ccloud_credential.password in your inventory."
  when:
    - "'usm_agent' in group_names"
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent CCloud Configuration is provided
  assert:
    that:
      - usm_agent_ccloud_host is defined
      - usm_agent_ccloud_host != ""
      - usm_agent_ccloud_environment_id is defined
      - usm_agent_ccloud_environment_id != ""
    fail_msg: "CCloud configuration (host and environment_id) are required for USM Agent to function. Please provide ccloud_host and ccloud_environment_id in your inventory."
  when:
    - "'usm_agent' in group_names"
  tags:
    - validate_usm_agent_configs

- name: Create USM Agent configuration baseline directory on control node
  file:
    path: "{{ playbook_dir }}/.usm_agent_baseline"
    state: directory
    mode: '755'
  delegate_to: localhost
  run_once: true
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
  tags:
    - validate_usm_agent_configs

- name: Record USM Agent Configuration Baseline (First Component Wins)
  copy:
    content: |
      {
        "basic_auth_enabled": {{ usm_agent_basic_auth_enabled | bool | to_json }},
        "ssl_enabled": {{ usm_agent_ssl_enabled | bool | to_json }},
        "ssl_mutual_auth_enabled": {{ usm_agent_ssl_mutual_auth_enabled | bool | to_json }},
        "recorded_by": "{{ inventory_hostname }}",
        "recorded_at": "{{ ansible_date_time.iso8601 }}"
      }
    dest: "{{ playbook_dir }}/.usm_agent_baseline/config.json"
    mode: '644'
    force: false
  delegate_to: localhost
  run_once: true
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
  tags:
    - validate_usm_agent_configs

- name: Read USM Agent Configuration Baseline
  slurp:
    src: "{{ playbook_dir }}/.usm_agent_baseline/config.json"
  register: usm_agent_baseline_raw
  delegate_to: localhost
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
  tags:
    - validate_usm_agent_configs

- name: Parse USM Agent Configuration Baseline
  set_fact:
    usm_agent_baseline: "{{ usm_agent_baseline_raw.content | b64decode | from_json }}"
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline_raw is defined
    - usm_agent_baseline_raw.content is defined
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent Basic Auth Configuration Consistency
  assert:
    that:
      - (usm_agent_basic_auth_enabled | bool) == (usm_agent_baseline.basic_auth_enabled | bool)
    fail_msg: |
      USM Agent basic auth configuration inconsistency detected:
      - Baseline value (set by {{ usm_agent_baseline.recorded_by }}): {{ usm_agent_baseline.basic_auth_enabled }}
      - Current host ({{ inventory_hostname }}) value: {{ usm_agent_basic_auth_enabled | bool }}

      All components must have same usm_agent_basic_auth_enabled values.
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent SSL Configuration Consistency
  assert:
    that:
      - (usm_agent_ssl_enabled | bool) == (usm_agent_baseline.ssl_enabled | bool)
    fail_msg: |
      USM Agent SSL configuration inconsistency detected:
      - Baseline value (set by {{ usm_agent_baseline.recorded_by }}): {{ usm_agent_baseline.ssl_enabled }}
      - Current host ({{ inventory_hostname }}) value: {{ usm_agent_ssl_enabled | bool }}

      All components must have same usm_agent_ssl_enabled values.
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs

- name: Validate USM Agent mTLS Configuration Consistency
  assert:
    that:
      - (usm_agent_ssl_mutual_auth_enabled | bool) == (usm_agent_baseline.ssl_mutual_auth_enabled | bool)
    fail_msg: |
      USM Agent mTLS configuration inconsistency detected:
      - Baseline value (set by {{ usm_agent_baseline.recorded_by }}): {{ usm_agent_baseline.ssl_mutual_auth_enabled }}
      - Current host ({{ inventory_hostname }}) value: {{ usm_agent_ssl_mutual_auth_enabled | bool }}

      All components must have same usm_agent_ssl_mutual_auth_enabled values.
  when:
    - "'usm_agent' in groups"
    - "groups['usm_agent'] | length > 0"
    - "('usm_agent' in group_names) or ('kafka_controller' in group_names) or ('kafka_broker' in group_names) or ('kafka_connect' in group_names)"
    - usm_agent_baseline is defined
  tags:
    - validate_usm_agent_configs
