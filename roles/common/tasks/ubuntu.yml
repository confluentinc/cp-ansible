---
- name: Install apt-transport-https
  apt:
    name: apt-transport-https
    update_cache: true
  register: install_apt_transport_result
  until: install_apt_transport_result is success  or ansible_check_mode
  retries: 5
  delay: 90
  tags: package

- name: Install gnupg for gpg-keys
  apt:
    name: gnupg2
  register: install_gnupg_result
  until: install_gnupg_result is success  or ansible_check_mode
  retries: 5
  delay: 90
  tags: package

- name: Debug - Show URL being used
  debug:
    msg: "Using URL: {{ confluent_common_repository_debian_key_url }}"
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Download Confluent Common Repository Key
  ansible.builtin.get_url:
    url: "{{ confluent_common_repository_debian_key_url }}"
    dest: /tmp/confluent-common-archive-keyring.gpg.tmp
    mode: '0644'
  register: download_common_key_result
  until: download_common_key_result is success
  retries: 5
  delay: 90
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: De-armor and Install Confluent Common Repository Key
  ansible.builtin.command:
    cmd: "gpg --dearmor -o /usr/share/keyrings/confluent-common-archive-keyring.gpg {{ download_common_key_result.dest }}"
  args:
    creates: /usr/share/keyrings/confluent-common-archive-keyring.gpg
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"
    - download_common_key_result.changed or not (download_common_key_result is skipped)

- name: Download Confluent Control Center Next Gen Repository Key
  ansible.builtin.get_url:
    url: "{{ confluent_control_center_next_gen_repository_debian_key_url }}"
    dest: /tmp/confluent-cc-archive-keyring.gpg.tmp
    mode: '0644'
  register: download_cc_key_result
  until: download_cc_key_result is success
  retries: 5
  delay: 90
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: De-armor and Install Confluent Control Center Next Gen Repository Key
  ansible.builtin.command:
    cmd: "gpg --dearmor -o /usr/share/keyrings/confluent-cc-archive-keyring.gpg {{ download_cc_key_result.dest }}"
  args:
    creates: /usr/share/keyrings/confluent-cc-archive-keyring.gpg
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"
    - download_cc_key_result.changed or not (download_cc_key_result is skipped)

- name: Clean up temporary key files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/confluent-common-archive-keyring.gpg.tmp
    - /tmp/confluent-cc-archive-keyring.gpg.tmp
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Verify Confluent Common Repository Key
  shell: gpg --show-keys /usr/share/keyrings/confluent-common-archive-keyring.gpg
  register: common_key_verification
  changed_when: false
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Display Confluent Common Repository Key Fingerprint
  debug:
    msg: "Confluent Common Repository Key: {{ common_key_verification.stdout_lines }}"
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Verify Confluent Control Center Next Gen Repository Key
  shell: gpg --show-keys /usr/share/keyrings/confluent-cc-archive-keyring.gpg
  register: cc_key_verification
  changed_when: false
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Display Confluent Control Center Next Gen Repository Key Fingerprint
  debug:
    msg: "Confluent Control Center Next Gen Repository Key: {{ cc_key_verification.stdout_lines }}"
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Ensure Custom Apt Repo does not Exists when repository_configuration is Confluent
  file:
    state: absent
    path: /etc/apt/sources.list.d/custom_confluent.list
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"
  notify:
    - apt-get update

- name: Add Confluent Repository
  apt_repository:
    repo: "{{ confluent_common_repository_debian_repository | replace('deb ', 'deb [signed-by=/usr/share/keyrings/confluent-common-archive-keyring.gpg] ') }}"
    state: present
    filename: confluent-common
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Add Confluent Control Center Next Gen Repository
  apt_repository:
    repo: "{{ confluent_control_center_next_gen_repository_debian_repository | replace('deb ', 'deb [signed-by=/usr/share/keyrings/confluent-cc-archive-keyring.gpg] ') }}"
    state: present
    filename: confluent-control-center-next-gen
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Add Confluent Clients Apt Key
  apt_key:
    url: "{{confluent_common_repository_debian_clients_key_url}}"
    state: present
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Add Confluent Clients Apt Repo
  apt_repository:
    repo: "{{confluent_common_repository_debian_clients_repository}}"
    state: present
  register: apt_add_result
  until: apt_add_result is success
  retries: 10
  delay: 5
  when:
    - repository_configuration == 'confluent'
    - installation_method == "package"

- name: Ensure Confluent Apt Repo does not Exists when repository_configuration is Custom
  apt_repository:
    repo: "{{item}}"
    state: absent
  loop:
    - "{{confluent_common_repository_debian_repository}}"
    - "{{confluent_control_center_next_gen_repository_debian_repository}}"
  when:
    - repository_configuration == 'custom'

- name: Ensure Confluent Clients Apt Repo does not Exists when repository_configuration is Custom
  apt_repository:
    repo: "{{confluent_common_repository_debian_clients_repository}}"
    state: absent
  when:
    - repository_configuration == 'custom'

- name: Add Custom Apt Repo
  copy:
    src: "{{custom_apt_repo_filepath}}"
    dest: /etc/apt/sources.list.d/custom_confluent.list
  register: apt_custom_add_result
  until: apt_custom_add_result is success
  retries: 5
  delay: 90
  when: repository_configuration == 'custom'
  notify:
    - apt-get update

- meta: flush_handlers

- name: Make Sure man pages Directory Exists
  file:
    path: /usr/share/man/man1
    state: directory
    mode: '755'

- name: Custom Java Install
  include_tasks: custom_java_install.yml

- name: Add open JDK repo
  apt_repository:
    repo: "{{ubuntu_java_repository}}"
  #Throttle was introduced to help mitigate the APT Lock when deploying multiple components to the same node.
  throttle: 1
  register: apt_add_jdk_result
  until: apt_add_jdk_result is success
  retries: 5
  delay: 90
  when:
    - repository_configuration == 'confluent'
    - install_java|bool

- name: Install Java
  apt:
    name: "{{ubuntu_java_package_name}}"
  register: java_install_result
  until: java_install_result is success  or ansible_check_mode
  retries: 10
  delay: 5
  when: install_java|bool
  tags: package

- name: Install OpenSSL
  apt:
    name: openssl
  tags: package

- name: Get Java Version
  shell: java -version
  register: version_output
  check_mode: false
  changed_when: false

- name: Print Java Version
  debug:
    msg: "Current Java Version is: {{version_output.stderr_lines[0]}}"

- name: Install pip
  apt:
    name:
      - python3-pip
    state: present
  become: true
  tags:
    - package
    - pip-package

- name: Upgrade pip
  ansible.builtin.pip:
    name: pip
    extra_args: --upgrade
  tags:
    - package
    - pip-package
  when:
    - ansible_distribution_major_version not in ['24']

- name: Install pip packages
  ansible.builtin.pip:
    name: "{{pip_packages}}"
  tags:
    - package
    - pip-package
  when:
    - ansible_distribution_major_version not in ['24']

- name: Install pip packages using apt
  apt:
    name:
      - "python3-{{item}}"
    state: present
  become: true
  loop: "{{pip_packages}}"
  tags: package
  when:
    - ansible_distribution_major_version == "24"

- name: Install pyyaml package using apt
  apt:
    name:
      - "python3-yaml"
    state: present
  become: true
  tags: package
